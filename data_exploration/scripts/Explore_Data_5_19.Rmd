---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library('DescTools')
library(geosphere)
library(sp)
```

```{r}
observations <- read_csv("../data/observation_phenology.csv")
location_months <- read_csv("../data/location_months_in_season.csv")

observations$stage <- as.factor(observations$stage)
observations$taxonomic_rank <- as.factor(observations$taxonomic_rank)
observations$taxonomic_rank_name <- as.factor(observations$taxonomic_rank_name)

location_months$taxonomic_rank <- as.factor(location_months$taxonomic_rank)
location_months$taxonomic_rank_name <- as.factor(location_months$taxonomic_rank_name)

observations$month <- month(observations$date)
```

```{r}
location_lat_lng <- unique(select(observations, c("location_id", "lat", "lng")))
```

```{r}
apples_observations <- observations[which(observations$scientific_name == "Malus pumila"), ]
apples_locations <- location_months[which(location_months$scientific_name == "Malus pumila"), ]

apples_locations$scientific_name <- NULL
apples_locations$scientific_synonyms <- NULL
apples_locations$en_name <- NULL
apples_locations$type_id <- NULL
apples_locations$taxonomic_rank <- NULL
apples_locations$taxonomic_rank_name <- NULL

apples_observations$scientific_name <- NULL
apples_observations$scientific_synonyms <- NULL
apples_observations$en_name <- NULL
apples_observations$type_id <- NULL
apples_observations$taxonomic_rank <- NULL
apples_observations$taxonomic_rank_name <- NULL
```

```{r}
apples_locations_matched <- merge(apples_locations, apples_observations, on="location_id")

apples_locations_matched <- apples_locations_matched %>% 
    drop_na() %>%
    mutate(month_diff = end_month - month) %>%
    mutate(grow_range = end_month - start_month) %>%
    mutate(in_grow_range = month_diff <= grow_range)
    
```

```{r}
get_species_dataframe <- function(scientific_name) {
    spec_observations <- observations[which(observations$scientific_name == scientific_name), ] %>%
        select(c("location_id", "lat", "lng", "stage", "month"))
    spec_locations <- location_months[which(location_months$scientific_name == scientific_name), ] %>%
        select(c("location_id", "start_month", "end_month"))
    
    merged <- merge(spec_locations, spec_observations, on="location_id") %>%
        drop_na()
    
    merged$month_diff = merged$end_month - merged$month
    merged$month_diff = apply(merged, 1, function(x) {
        if (x$end_month < x$month) {
            
        }
        
    })
    merged$grow_range = merged$end_month - merged$start_months
    merged$in_grow_range = merged$month_diff <= merged$grow_range
    
    # Add 12 to this calculation if end month < start_month. 
    
    merged$northern_hemisphere = merged$lat > 0
    
    return(merged)
}
```

```{r}
example_lemons <- get_species_dataframe("Citrus x limon")
```

```{r}
unique_species <- unique(observations$scientific_name)

species_list <- list(lapply(unique_species, FUN = get_species_dataframe))
names(species_list[[1]]) <- unique_species
species_df <- bind_rows(species_list[[1]], .id="species")

north_species_df <- species_df[species_df$northern_hemisphere,]
south_species_df <- species_df[!species_df$northern_hemisphere,]
```


## Models

Need to model stage by in_grow_range?
Make sure grow range is accurate due to month wraparound.
```{r}
table(apples_locations_matched$in_grow_range, apples_locations_matched$stage)

chisq.test(apples_locations_matched$in_grow_range, apples_locations_matched$stage)

ContCoef(apples_locations_matched$in_grow_range, apples_locations_matched$stage, correct = FALSE)
ContCoef(apples_locations_matched$in_grow_range, apples_locations_matched$stage, correct = TRUE)
```

```{r}
chisq.test(species_df$in_grow_range, species_df$stage)

ContCoef(species_df$in_grow_range, species_df$stage, correct = FALSE)
ContCoef(species_df$in_grow_range, species_df$stage, correct = TRUE)

print("Northern Hemisphere:")

chisq.test(north_species_df$in_grow_range, north_species_df$stage)

ContCoef(north_species_df$in_grow_range, north_species_df$stage, correct = FALSE)
ContCoef(north_species_df$in_grow_range, north_species_df$stage, correct = TRUE)

print("southern hemisphere:")
chisq.test(south_species_df$in_grow_range, south_species_df$stage)

ContCoef(south_species_df$in_grow_range, south_species_df$stage, correct = FALSE)
ContCoef(south_species_df$in_grow_range, south_species_df$stage, correct = TRUE)
```

summary:

Number of observations plays a huge role. 
Separating by hemisphere helps a lot. Harvest calendars will be a great source. 
Missing data is a massive problem, if we figured out interpolation we could have ~2x as much data.

How to test this? Chi-square is ok, but not complete. 

Growing range from this dataset might be an incomplete assumption. 

K-means clustering could help group together similar growing ranges.

Also "near growing range" is important. many of the "falses" are only 1 month off. 

Questions:
Does unripe fruit include over-ripe?


## Getting close observations 

Distance function:
distm(c(lon1, lat1), c(lon2, lat2), fun = distHaversine) 

From coordinates, need to find closest observations (closest 5? weight the first one more heavily)
```{r}
closest_observations <-  function(input_lng, input_lat, num_locations=5) {
    
    distances <- apples_locations_matched %>%
        rowwise() %>% mutate(distance = distm(c(input_lng, input_lat), c(lng, lat), fun=distHaversine)) %>%
        select(c("location_id", "lng", "lat", "distance", "stage", "month", "month_diff", "grow_range", "in_grow_range")) %>%
        arrange(distance)
    
    return(distances)
}
```


```{r}
test_obs <- closest_observations(-100, 40)[1:24,]

chisq.test(test_obs$in_grow_range, test_obs$stage)

ContCoef(test_obs$in_grow_range, test_obs$stage, correct = FALSE)
ContCoef(test_obs$in_grow_range, test_obs$stage, correct = TRUE)
```

Lots of misisng values, interpolation?

K-means clustering by grow season?
```{r}
species_k <- kmeans(obs_north 12, nstart=25)
```

